From ed6a507c3def05c69e883864f085491e3d4dfb89 Mon Sep 17 00:00:00 2001
From: JulienBalestra <julien.balestra@gmail.com>
Date: Sun, 26 Mar 2017 21:18:47 +0200
Subject: [PATCH] Add the support of volumes in Kubelet runonce

---
 pkg/kubelet/runonce.go | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/pkg/kubelet/runonce.go b/pkg/kubelet/runonce.go
index 9ad3c47..aea506f 100644
--- a/pkg/kubelet/runonce.go
+++ b/pkg/kubelet/runonce.go
@@ -54,6 +54,11 @@ func (kl *Kubelet) RunOnce(updates <-chan kubetypes.PodUpdate) ([]RunPodResult,
 		}
 	}
 
+	// Start volume manager
+	stopCh := make(chan struct{})
+	go kl.volumeManager.Run(kl.sourcesReady, stopCh)
+	defer func(stopCh chan struct{}) { stopCh <- struct{}{} }(stopCh)
+
 	select {
 	case u := <-updates:
 		glog.Infof("processing manifest with %d pods", len(u.Pods))
@@ -125,6 +130,7 @@ func (kl *Kubelet) runPod(pod *api.Pod, retryDelay time.Duration) error {
 			glog.Errorf("Failed creating a mirror pod %q: %v", format.Pod(pod), err)
 		}
 		mirrorPod, _ := kl.podManager.GetMirrorPodByPod(pod)
+		kl.podManager.UpdatePod(pod)
 		if err = kl.syncPod(syncPodOptions{
 			pod:        pod,
 			mirrorPod:  mirrorPod,
-- 
2.7.4

