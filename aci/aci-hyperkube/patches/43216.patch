From 11dfe7407784029747ec74ea3836b05a8e0f000e Mon Sep 17 00:00:00 2001
From: Julien Balestra <julien.balestra@gmail.com>
Date: Thu, 16 Mar 2017 14:48:34 +0100
Subject: [PATCH] Kubelet:rkt Create any missing hostPath Volumes

---
 pkg/kubelet/rkt/rkt.go | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/pkg/kubelet/rkt/rkt.go b/pkg/kubelet/rkt/rkt.go
index 5be3f8b..25fca89 100644
--- a/pkg/kubelet/rkt/rkt.go
+++ b/pkg/kubelet/rkt/rkt.go
@@ -1296,6 +1296,25 @@ func (r *Runtime) setupPodNetwork(pod *api.Pod) (string, string, error) {
 	return netnsName, status.IP.String(), nil
 }
 
+// For a hostPath volume: rkt doesn't create any missing volume on the node/host so we need to create it
+func createHostPathVolumes(pod *api.Pod) error {
+	for _, v := range pod.Spec.Volumes {
+		if v.VolumeSource.HostPath != nil {
+			_, err := os.Stat(v.HostPath.Path)
+			if err != nil && os.IsNotExist(err) {
+				err = os.MkdirAll(v.HostPath.Path, os.ModePerm)
+				if err != nil {
+					return err
+				}
+				glog.V(4).Infof("Created volume HostPath %q for Pod %q", v.HostPath.Path, format.Pod(pod))
+			} else if err != nil {
+				return err
+			}
+		}
+	}
+	return nil
+}
+
 // RunPod first creates the unit file for a pod, and then
 // starts the unit over d-bus.
 func (r *Runtime) RunPod(pod *api.Pod, pullSecrets []api.Secret) error {
@@ -1304,6 +1323,12 @@ func (r *Runtime) RunPod(pod *api.Pod, pullSecrets []api.Secret) error {
 	var err error
 	var netnsName string
 	var podIP string
+
+	err = createHostPathVolumes(pod)
+	if err != nil {
+		return err
+	}
+
 	netnsName, podIP, err = r.setupPodNetwork(pod)
 	if err != nil {
 		r.cleanupPodNetwork(pod)
-- 
2.7.4

